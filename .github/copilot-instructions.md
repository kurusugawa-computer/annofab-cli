# copilot-instructions.md

## プロジェクトの目的
AnnofabのCLIです。

## 開発でよく使うコマンド
* コードのフォーマット: `make format`
* Lintの実行: `make lint`
* テストの実行: `make test`
* ドキュメントの実行: `make docs`

## 技術スタック
* Python 3.9 以上
* テストフレームワーク: Pytest v8 以上

## ディレクトリ構造概要

* `annofabcli/**`: アプリケーションのソースコード
* `tests/**`: テストコード
    * `tests/data/**`: テストコードが参照するリソース
* `docs/*`: ドキュメント
    * `docs/command_reference/**`: コマンドリファレンス

## コーディングスタイル

### Python
* dictから値を取得する際、必須なキーならばブラケット記法を使う。キーが必須がどうか分からない場合は、必須とみなす。
* できるだけ`os.path`でなく`pathlib.Path`を使う（Lint`flake8-use-pathlib`に従う）
* Noneの判定、空文字列の判定、長さが0のコレクションの判定は、falsyとして判定するのでなく、`if a is not None:`のように判定内容を明記してください。
* 型ヒントを`dict`にする場合、`dict[str, Any]`のようにキーと値の型を指定する。
* 変数などに対するコメントは行末に書くのでなく、docstringを使って下の行に書く。


### ログメッセージ
* 日本語で書く。
* 複数件のリソースを処理するコマンドでは、何件目を処理しているか分かるようにする。
* 複数件のリソースを処理するコマンドでは、

#### ログレベル
* warning: ユーザーにとって想定外の事態が発生した場合
    * エラーをキャッチして、かつ処理を継続できるとき
    * 更新対象のリソースが存在しないとき
    * 入力値が不正なとき
* info: ユーザーにとって有用な情報を提供する場合
    * コマンドの開始、終了
* debug: 細かく進捗を把握するのに役立つ情報
    * 各リソースの情報
    * 各リソースごとに成功したという情報
    
    
#### 複数件のリソースを処理するコマンド（たとえば`input_data update`コマンドなど）の場合
* 何件目を処理しているかをログに出力する。
* 100件や1000件など、適当な件数ごとに進捗をinfoレベルでログに出力する。
* 全部の処理が完了した後に、成功件数、スキップ件数、失敗件数をログにinfoレベルで出力する。
* ログメッセージの区切れは` :: `を使う。
* try-exceptでエラーをキャッチした場合は、`logger.warning(..., exc_info=True)`を使って、スタックとレースも出力する。


### テストコード
* Errorの確認は、`pytest.raises`を使用する。エラーメッセージの確認は行わない。
* テストファイルは、`test_*.py`の形式で作成する。ディレクトリ構成は`src`と対応させる。
* 一時ディレクトリを使用する場合は、`tmp_path` fixtureを利用する。
* WebAPIにアクセスするようのモックは作成しないこと。コード量が増えてメンテナンスができなくなるため。

### ドキュメント
* コマンドのドキュメントは、`docs/command_reference/`に作成する。
* コマンドの末尾には以下のように`.. argparse::`ディレクティブを追加して、`argparse`から自動生成されるUsage Detailsセクションを挿入する。

```
Usage Details
=================================

.. argparse::
    :ref: annofabcli.comment.list_comment.add_parser
    :prog: annofabcli comment list
    :nosubcommands:
    :nodefaultconst:
```

* documentのタイトルは`task list`のようなコマンド名にする


## 作業の進め方
1. コードの修正が完了したら`make format`を実行してフォーマットする。
2. Gitにコミットする。コミットメッセージはAIが生成したことが分かるようにする。
3. `make lint`を実行してエラーがないことを確認する。
4. エラーがあれば修正して、手順1に戻る。
5. コードの修正が完了したら、対象コマンドのドキュメント（`docs/command_reference/`以下）を修正すべきかどうか検討する。ドキュメントの修正が必要な場合は、忘れずに修正する。
6. 必要ならばテストコードも記載する。


## ユーザーインタフェイス
* 複数リソースを処理するコマンドは`--parallelism`を用意する。ただし、プロジェクトに対する操作や削除処理など、間違えて処理したときの被害が大きいコマンドは`--parallelism`を用意しない。


## レビュー
* PRレビューの際は、日本語でレビューを行う
